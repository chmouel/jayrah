<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jayrah - Jira Web UI</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <style>
        :root {
            --primary-color: #0052cc;
            --primary-hover: #0747a6;
            --secondary-color: #f4f5f7;
            --text-color: #172b4d;
            --text-muted: #6b778c;
            --border-color: #dfe1e6;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 8px rgba(0, 0, 0, 0.15);
            --success-color: #36b37e;
            --warning-color: #ffab00;
            --error-color: #de350b;
            --radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            padding: 1.5rem 0;
            box-shadow: var(--shadow);
            flex-shrink: 0;
        }

        .header-content {
            width: 100%;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .stats {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.9rem;
        }

        .container {
            display: flex;
            flex-direction: column;
            flex: 1;
            width: 100%;
            padding: 1rem 2rem;
            gap: 1rem;
            min-height: 0;
        }

        .search-container {
            background: white;
            padding: 1rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            flex-shrink: 0;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.1);
        }

        .main-content {
            display: flex;
            gap: 1rem;
            flex: 1;
            min-height: 0;
        }

        .issues-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .issues-header {
            background: var(--secondary-color);
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .table-container {
            flex: 1;
            overflow: auto;
            min-height: 0;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            min-width: 800px;
            /* Ensure horizontal scrolling */
        }

        .table th {
            background: var(--secondary-color);
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        .table th:nth-child(1) {
            width: 60px;
        }

        /* Type */
        .table th:nth-child(2) {
            width: 120px;
        }

        /* Key */
        .table th:nth-child(3) {
            min-width: 200px;
        }

        /* Summary */
        .table th:nth-child(4) {
            width: 120px;
        }

        /* Status */
        .table th:nth-child(5) {
            width: 120px;
        }

        /* Priority */
        .table th:nth-child(6) {
            width: 140px;
        }

        /* Assignee */
        .table th:nth-child(7) {
            width: 100px;
        }

        /* Created */
        .table th:nth-child(8) {
            width: 100px;
        }

        /* Updated */

        .table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
            white-space: nowrap;
        }

        .table td:nth-child(3) {
            /* Summary column can wrap */
            white-space: normal;
        }

        .table tbody tr {
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        .table tbody tr:hover {
            background: rgba(0, 82, 204, 0.04);
        }

        .table tbody tr.selected {
            background: rgba(0, 82, 204, 0.08);
            border-left: 4px solid var(--primary-color);
        }

        .issue-type {
            font-size: 1.2rem;
            display: inline-block;
            width: 2rem;
            text-align: center;
        }

        .issue-key {
            font-family: 'Monaco', 'Menlo', monospace;
            font-weight: 600;
            color: var(--primary-color);
            text-decoration: none;
        }

        .issue-key:hover {
            text-decoration: underline;
        }

        .issue-summary {
            font-weight: 500;
            min-width: 200px;
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-todo {
            background: #e6f3ff;
            color: #0052cc;
        }

        .status-progress {
            background: #fff7e6;
            color: #ff8b00;
        }

        .status-review {
            background: #f3e6ff;
            color: #6554c0;
        }

        .status-done {
            background: #e6ffed;
            color: #00875a;
        }

        .status-default {
            background: var(--secondary-color);
            color: var(--text-muted);
        }

        .user-avatar {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .date {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .detail-panel {
            flex: 1;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .detail-panel.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-style: italic;
        }

        .detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--secondary-color);
            flex-shrink: 0;
        }

        .detail-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0.25rem;
            border-radius: var(--radius);
            transition: background-color 0.2s ease;
        }

        .close-btn:hover {
            background: var(--border-color);
        }

        .detail-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-section h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .detail-field {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 1rem;
            margin-bottom: 0.75rem;
            align-items: start;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .detail-value {
            color: var(--text-color);
        }

        .detail-description {
            background: var(--secondary-color);
            padding: 1rem;
            border-radius: var(--radius);
            border-left: 4px solid var(--primary-color);
            margin-top: 0.5rem;
            line-height: 1.6;
        }

        .detail-description h1,
        .detail-description h2,
        .detail-description h3,
        .detail-description h4,
        .detail-description h5,
        .detail-description h6 {
            margin: 1em 0 0.5em 0;
            color: var(--text-color);
        }

        .detail-description h1:first-child,
        .detail-description h2:first-child,
        .detail-description h3:first-child,
        .detail-description h4:first-child,
        .detail-description h5:first-child,
        .detail-description h6:first-child {
            margin-top: 0;
        }

        .detail-description p {
            margin: 0.75em 0;
        }

        .detail-description ul,
        .detail-description ol {
            margin: 0.75em 0;
            padding-left: 2em;
        }

        .detail-description li {
            margin: 0.25em 0;
        }

        .detail-description pre {
            background: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
            margin: 1em 0;
        }

        .detail-description code {
            background: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 0.2em 0.4em;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
        }

        .detail-description pre code {
            background: none;
            border: none;
            padding: 0;
        }

        .detail-description blockquote {
            border-left: 4px solid var(--border-color);
            margin: 1em 0;
            padding-left: 1em;
            color: var(--text-muted);
        }

        .detail-description a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .detail-description a:hover {
            text-decoration: underline;
        }

        .detail-labels {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .label-tag {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .detail-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .detail-link:hover {
            text-decoration: underline;
        }

        .raw-json-toggle {
            background: var(--secondary-color);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            cursor: pointer;
            margin-top: 1rem;
        }

        .raw-json-toggle:hover {
            background: var(--border-color);
        }

        .raw-json {
            display: none;
            white-space: pre-wrap;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75rem;
            background: var(--secondary-color);
            padding: 1rem;
            border-radius: var(--radius);
            overflow-x: auto;
            margin-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .no-issues {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }

            .issues-panel {
                max-height: 50vh;
                min-height: 300px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }

            .header-content {
                padding: 0 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .table {
                font-size: 0.75rem;
                min-width: 600px;
                /* Maintain horizontal scroll on mobile */
            }

            .table th,
            .table td {
                padding: 0.5rem;
            }

            .issue-summary {
                min-width: 150px;
                max-width: 250px;
            }

            .user-avatar span {
                display: none;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="header-content">
            <h1>🚀 Jayrah - Jira Web UI</h1>
            <div class="stats" id="stats">Loading...</div>
        </div>
    </header>

    <div class="container">
        <div class="search-container">
            <input type="text" id="search" class="search-input"
                placeholder="🔍 Search issues by key, summary, assignee, status..." />
        </div>

        <div class="main-content">
            <div class="issues-panel">
                <div class="issues-header">
                    <span>Issues</span>
                    <span id="issue-count" class="stats">0 issues</span>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Key</th>
                                <th>Summary</th>
                                <th>Status</th>
                                <th>Assignee</th>
                                <th>Reporter</th>
                                <th>Created</th>
                                <th>Updated</th>
                            </tr>
                        </thead>
                        <tbody id="issues-tbody">
                            <tr>
                                <td colspan="8" class="loading">Loading issues...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="detail-panel" class="detail-panel empty">
                <div style="text-align: center; color: var(--text-muted);">
                    📋 Select an issue to view details
                </div>
            </div>
        </div>
    </div>

    <script>
        let allIssues = [];
        let selectedRow = null;

        // Convert Jira markup to standard markdown
        function convertJiraToMarkdown(text) {
            if (!text) return '';
            
            // Handle different text formats
            if (typeof text === 'object') {
                // If it's an object, try to extract text content
                if (text.content) {
                    // Handle ADF (Atlassian Document Format)
                    return extractTextFromADF(text);
                } else if (text.raw) {
                    text = text.raw;
                } else {
                    text = JSON.stringify(text);
                }
            }
            
            // Convert Jira markup to standard markdown
            let markdown = text.toString();
            
            // Headers: h1. -> #, h2. -> ##, etc.
            markdown = markdown.replace(/^h([1-6])\.\s+(.+)$/gm, (match, level, content) => {
                return '#'.repeat(parseInt(level)) + ' ' + content;
            });
            
            // Bold: *text* -> **text**
            markdown = markdown.replace(/\*([^*]+)\*/g, '**$1**');
            
            // Italic: _text_ -> *text*
            markdown = markdown.replace(/_([^_]+)_/g, '*$1*');
            
            // Code blocks: {code} -> ```
            markdown = markdown.replace(/\{code(?::([^}]*))?\}([\s\S]*?)\{code\}/g, (match, lang, code) => {
                return '```' + (lang || '') + '\n' + code.trim() + '\n```';
            });
            
            // Inline code: {{text}} -> `text`
            markdown = markdown.replace(/\{\{([^}]+)\}\}/g, '`$1`');
            
            // Links: [text|url] -> [text](url)
            markdown = markdown.replace(/\[([^|\]]+)\|([^\]]+)\]/g, '[$1]($2)');
            
            // Lists: * item -> - item (already compatible)
            // Numbers: # item -> 1. item
            markdown = markdown.replace(/^#\s+(.+)$/gm, '1. $1');
            
            // Line breaks: Convert \r\n or \n to proper breaks
            markdown = markdown.replace(/\r\n/g, '\n');
            
            return markdown;
        }
        
        // Extract text from Atlassian Document Format (ADF)
        function extractTextFromADF(adf) {
            if (!adf || typeof adf !== 'object') return '';
            
            let text = '';
            
            if (adf.type === 'text') {
                text = adf.text || '';
                // Apply marks if present
                if (adf.marks) {
                    adf.marks.forEach(mark => {
                        if (mark.type === 'strong') text = `**${text}**`;
                        if (mark.type === 'em') text = `*${text}*`;
                        if (mark.type === 'code') text = `\`${text}\``;
                        if (mark.type === 'link') text = `[${text}](${mark.attrs?.href || ''})`;
                    });
                }
            } else if (adf.type === 'paragraph') {
                if (adf.content) {
                    text = adf.content.map(extractTextFromADF).join('') + '\n\n';
                }
            } else if (adf.type === 'heading') {
                const level = adf.attrs?.level || 1;
                if (adf.content) {
                    text = '#'.repeat(level) + ' ' + adf.content.map(extractTextFromADF).join('') + '\n\n';
                }
            } else if (adf.type === 'codeBlock') {
                const lang = adf.attrs?.language || '';
                if (adf.content) {
                    text = '```' + lang + '\n' + adf.content.map(extractTextFromADF).join('') + '\n```\n\n';
                }
            } else if (adf.type === 'bulletList' || adf.type === 'orderedList') {
                if (adf.content) {
                    text = adf.content.map(item => {
                        const prefix = adf.type === 'bulletList' ? '- ' : '1. ';
                        return prefix + extractTextFromADF(item);
                    }).join('') + '\n';
                }
            } else if (adf.type === 'listItem') {
                if (adf.content) {
                    text = adf.content.map(extractTextFromADF).join('') + '\n';
                }
            } else if (adf.content) {
                // Recursively process content array
                text = adf.content.map(extractTextFromADF).join('');
            }
            
            return text;
        }
        
        // Convert markdown to HTML
        function markdownToHtml(markdown) {
            if (!markdown) return '';
            return marked.parse(markdown);
        }

        async function fetchIssues(q = "") {
            try {
                const url = q ? `/api/issues?q=${encodeURIComponent(q)}` : "/api/issues";
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            } catch (error) {
                console.error('Error fetching issues:', error);
                return [];
            }
        }

        async function fetchIssueDetail(key) {
            try {
                const res = await fetch(`/api/issue/${key}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                return data;
            } catch (error) {
                console.error('Error fetching issue detail:', error);
                return { error: 'Failed to load issue details' };
            }
        }

        function formatIssueDetail(data) {
            if (data.error) {
                return `<div class="detail-section"><p style="color: var(--error-color);">Error: ${data.error}</p></div>`;
            }

            const issue = data.issue || data; // Handle both old and new format
            const customFields = data.custom_fields || [];
            const fields = issue.fields || {};
            const key = issue.key || 'Unknown';
            const summary = fields.summary || 'No summary';
            const description = fields.description || 'No description provided';
            const status = fields.status?.name || 'Unknown';
            const assignee = fields.assignee?.displayName || fields.assignee?.name || 'Unassigned';
            const reporter = fields.reporter?.displayName || fields.reporter?.name || 'Unknown';
            const priority = fields.priority?.name || 'Unknown';
            const issueType = fields.issuetype?.name || 'Unknown';
            const created = fields.created ? new Date(fields.created).toLocaleString() : 'Unknown';
            const updated = fields.updated ? new Date(fields.updated).toLocaleString() : 'Unknown';
            const labels = fields.labels || [];
            const components = fields.components || [];
            const fixVersions = fields.fixVersions || [];

            let html = `
                <div class="detail-section">
                    <h3>📋 Issue Information</h3>
                    <div class="detail-field">
                        <div class="detail-label">Key:</div>
                        <div class="detail-value"><strong>${key}</strong></div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-label">Type:</div>
                        <div class="detail-value">${issueType}</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-label">Status:</div>
                        <div class="detail-value"><span class="status-badge ${getStatusClass(status)}">${status}</span></div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-label">Priority:</div>
                        <div class="detail-value">${priority}</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-label">Summary:</div>
                        <div class="detail-value"><strong>${summary}</strong></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>👥 People</h3>
                    <div class="detail-field">
                        <div class="detail-label">Assignee:</div>
                        <div class="detail-value">
                            <div class="user-avatar">
                                <div class="avatar">${getUserInitials(assignee)}</div>
                                <span>${assignee}</span>
                            </div>
                        </div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-label">Reporter:</div>
                        <div class="detail-value">
                            <div class="user-avatar">
                                <div class="avatar">${getUserInitials(reporter)}</div>
                                <span>${reporter}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>📅 Dates</h3>
                    <div class="detail-field">
                        <div class="detail-label">Created:</div>
                        <div class="detail-value">${created}</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-label">Updated:</div>
                        <div class="detail-value">${updated}</div>
                    </div>
                </div>
            `;

            if (labels.length > 0) {
                html += `
                    <div class="detail-section">
                        <h3>🏷️ Labels</h3>
                        <div class="detail-labels">
                            ${labels.map(label => `<span class="label-tag">${label}</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            if (components.length > 0) {
                html += `
                    <div class="detail-section">
                        <h3>🔧 Components</h3>
                        <div class="detail-value">
                            ${components.map(comp => comp.name || comp).join(', ')}
                        </div>
                    </div>
                `;
            }

            if (fixVersions.length > 0) {
                html += `
                    <div class="detail-section">
                        <h3>🎯 Fix Versions</h3>
                        <div class="detail-value">
                            ${fixVersions.map(ver => ver.name || ver).join(', ')}
                        </div>
                    </div>
                `;
            }

            // Show custom fields if present
            if (customFields.length > 0) {
                let customFieldsHtml = '';
                customFields.forEach(cf => {
                    const fieldId = cf.field;
                    const fieldName = cf.name || fieldId;
                    const fieldType = cf.type || 'string';

                    if (fieldId && fields[fieldId]) {
                        let value = fields[fieldId];

                        // Handle different value types
                        if (Array.isArray(value)) {
                            value = value.map(v => {
                                if (typeof v === 'object' && v !== null) {
                                    return v.value || v.name || v.displayName || JSON.stringify(v);
                                }
                                return v;
                            }).filter(v => v).join(', ');
                        } else if (typeof value === 'object' && value !== null) {
                            value = value.value || value.name || value.displayName || JSON.stringify(value);
                        }

                        if (value) {
                            if (fieldType === 'text') {
                                customFieldsHtml += `
                                    <div class="detail-field">
                                        <div class="detail-label">${fieldName}:</div>
                                        <div class="detail-value">
                                            <div class="detail-description">${value}</div>
                                        </div>
                                    </div>
                                `;
                            } else if (fieldType === 'url') {
                                customFieldsHtml += `
                                    <div class="detail-field">
                                        <div class="detail-label">${fieldName}:</div>
                                        <div class="detail-value">
                                            <a href="${value}" class="detail-link" target="_blank">${value}</a>
                                        </div>
                                    </div>
                                `;
                            } else {
                                customFieldsHtml += `
                                    <div class="detail-field">
                                        <div class="detail-label">${fieldName}:</div>
                                        <div class="detail-value">${value}</div>
                                    </div>
                                `;
                            }
                        }
                    }
                });

                if (customFieldsHtml) {
                    html += `
                        <div class="detail-section">
                            <h3>🔧 Fields</h3>
                            ${customFieldsHtml}
                        </div>
                    `;
                }
            }

            html += `
                <div class="detail-section">
                    <h3>📝 Description</h3>
                    <div class="detail-description">${markdownToHtml(convertJiraToMarkdown(description))}</div>
                </div>

                <button class="raw-json-toggle" onclick="toggleRawJson()">
                    🔍 Show Raw JSON
                </button>
                <div class="raw-json" id="raw-json">${JSON.stringify(issue, null, 2)}</div>
            `;

            return html;
        }

        function toggleRawJson() {
            const rawJson = document.getElementById('raw-json');
            const button = document.querySelector('.raw-json-toggle');

            if (rawJson.style.display === 'none' || rawJson.style.display === '') {
                rawJson.style.display = 'block';
                button.textContent = '📋 Hide Raw JSON';
            } else {
                rawJson.style.display = 'none';
                button.textContent = '🔍 Show Raw JSON';
            }
        }

        function getStatusClass(status) {
            const statusLower = status.toLowerCase();
            if (statusLower.includes('todo') || statusLower.includes('new') || statusLower.includes('open')) return 'status-todo';
            if (statusLower.includes('progress') || statusLower.includes('doing')) return 'status-progress';
            if (statusLower.includes('review') || statusLower.includes('qa')) return 'status-review';
            if (statusLower.includes('done') || statusLower.includes('closed') || statusLower.includes('resolved')) return 'status-done';
            return 'status-default';
        }

        function getUserInitials(name) {
            if (!name || name === 'None') return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function renderTable(issues) {
            const tbody = document.getElementById('issues-tbody');

            if (issues.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-issues">No issues found</td></tr>';
                return;
            }

            tbody.innerHTML = issues.map((row, index) => `
                <tr onclick="selectRow(this, '${row[1]}')">
                    <td><span class="issue-type">${row[0]}</span></td>
                    <td><a href="#" class="issue-key">${row[1]}</a></td>
                    <td><div class="issue-summary" title="${row[2]}">${row[2]}</div></td>
                    <td><span class="status-badge ${getStatusClass(row[3])}">${row[3]}</span></td>
                    <td>
                        <div class="user-avatar">
                            <div class="avatar">${getUserInitials(row[4])}</div>
                            <span>${row[4]}</span>
                        </div>
                    </td>
                    <td>
                        <div class="user-avatar">
                            <div class="avatar">${getUserInitials(row[5])}</div>
                            <span>${row[5]}</span>
                        </div>
                    </td>
                    <td><span class="date">${formatDate(row[6])}</span></td>
                    <td><span class="date">${formatDate(row[7])}</span></td>
                </tr>
            `).join('');

            updateStats(issues.length);
        }

        function updateStats(count) {
            document.getElementById('stats').textContent = `${count} issue${count !== 1 ? 's' : ''}`;
            document.getElementById('issue-count').textContent = `${count} issue${count !== 1 ? 's' : ''}`;
        }

        async function selectRow(row, key) {
            // Remove previous selection
            if (selectedRow) {
                selectedRow.classList.remove('selected');
            }

            // Select new row
            selectedRow = row;
            row.classList.add('selected');

            // Show detail panel
            const detail = await fetchIssueDetail(key);
            showDetail(key, detail);
        }

        function showDetail(key, detail) {
            const panel = document.getElementById('detail-panel');
            panel.classList.remove('empty');

            panel.innerHTML = `
                <div class="detail-header">
                    <div class="detail-title">${key}</div>
                    <button class="close-btn" onclick="closeDetail()">&times;</button>
                </div>
                <div class="detail-content">${formatIssueDetail(detail)}</div>
            `;
        }

        function closeDetail() {
            const panel = document.getElementById('detail-panel');
            panel.classList.add('empty');
            panel.innerHTML = `
                <div style="text-align: center; color: var(--text-muted);">
                    📋 Select an issue to view details
                </div>
            `;

            if (selectedRow) {
                selectedRow.classList.remove('selected');
                selectedRow = null;
            }
        }

        // Search functionality with debouncing
        let searchTimeout;
        document.getElementById('search').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const issues = await fetchIssues(e.target.value);
                renderTable(issues);
                closeDetail(); // Close detail panel when searching
            }, 300);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeDetail();
            }
        });

        // Initial load
        async function init() {
            allIssues = await fetchIssues();
            renderTable(allIssues);
        }

        init();
    </script>
</body>

</html>